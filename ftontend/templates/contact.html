{% extends "base.html" %}
{% load static %}
{% block title %}NeXus ‚Äî –ß–∞—Ç —Å –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    :root {
      --color-primary: #007AFF;
      --color-bg: #F5F5F7;
      --color-bg-secondary: #FFFFFF;
      --color-text: #1D1D1F;
      --color-text-secondary: #6E6E73;
      --color-border: #D2D2D7;
      --color-shadow: rgba(0, 0, 0, 0.08);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', sans-serif;
      background-color: var(--color-bg);
      color: var(--color-text);
      line-height: 1.5;
      overflow-wrap: anywhere;
    }
    button, a, input { transition: all 0.3s ease; }
    .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid var(--color-border);
      border-radius: 18px;
      box-shadow: 0 4px 30px var(--color-shadow);
    }
    button:hover, a:hover { transform: translateY(-1px); }
    .message {
      max-width: 75%;
      padding: 0.75rem 1.25rem;
      border-radius: 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .animate-fade-in { animation: fade-in 0.3s ease forwards; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .user-message {
      align-self: flex-end;
      background: var(--color-primary);
      color: #fff;
      border-bottom-right-radius: 0.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .bot-message {
      align-self: flex-start;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      color: var(--color-text);
      border-bottom-left-radius: 0.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .message-image {
      max-width: 50%;
      padding: 0.25rem;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
    }
    .message-image img { width: 100%; border-radius: 0.5rem; }
    .media-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 0.5rem;
      overflow: hidden;
      border: 1px solid var(--color-border);
    }
    .media-preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .media-preview-item button {
      position: absolute;
      top: 0.25rem;
      right: 0.25rem;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .media-preview-item button:hover { background: rgba(0, 0, 0, 0.7); }
    @keyframes slide-in { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .animate-slide-in { animation: slide-in 0.3s ease; }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ—Å—Ç–∞ */
    .test-container {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
      max-width: 100%;
    }
    .test-question {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--color-text);
    }
    .test-option {
      display: block;
      width: 100%;
      text-align: left;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 0.75rem;
      padding: 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    .test-option:hover {
      background: var(--color-primary);
      color: white;
      transform: translateY(-2px);
      border-color: var(--color-primary);
    }
    .test-progress {
      width: 100%;
      height: 6px;
      background: var(--color-border);
      border-radius: 3px;
      margin: 1rem 0;
      overflow: hidden;
    }
    .test-progress-bar {
      height: 100%;
      background: var(--color-primary);
      transition: width 0.3s ease;
    }
    .test-results {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 1rem;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    .test-type-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 1rem;
      margin: 0.5rem 0;
      backdrop-filter: blur(10px);
    }
    
    .university-button {
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }
    .university-button:hover { background: #0051CC; transform: translateY(-1px); }
  </style>
{% endblock %}

{% block content %}
  <div class="max-w-5xl mx-auto px-6 py-12 flex-1">
    <h1 class="text-3xl font-semibold tracking-tight mb-8">–ß–∞—Ç —Å –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º –ø–æ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏</h1>
    <div class="card flex flex-col" style="min-height: calc(100vh - 12rem);">
      <div id="chat-container" class="flex-1 p-4 overflow-y-auto space-y-3 bg-[var(--color-bg)] flex flex-col">
        <!-- Messages will be loaded here -->
      </div>
      <div class="p-4 border-t border-[var(--color-border)]">
        <div id="media-preview" class="hidden flex gap-2 mb-4 flex-wrap"></div>
        <form id="chat-form" class="flex gap-2" style="flex-wrap: wrap;">
          <input type="text" id="chat-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è—Ö, –≤—É–∑–∞—Ö –∏–ª–∏ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏..." class="flex-grow min-w-[150px] border border-[var(--color-border)] rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]" />
          <label for="chat-file" class="cursor-pointer text-[var(--color-primary)] hover:underline flex items-center px-3 shrink-0" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
            <i class="fas fa-paperclip"></i>
          </label>
          <input type="file" id="chat-file" accept="image/*" style="display:none" multiple />
          <button id="cancel-media" type="button" class="bg-red-500 text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-red-600 shadow-sm hidden">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="bg-[var(--color-primary)] text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-[#0051CC] shadow-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <button type="button" id="clear-chat" class="bg-gray-500 text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-gray-600 shadow-sm">–ù–æ–≤—ã–π —á–∞—Ç</button>
        </form>
      </div>
    </div>
  </div>
{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Chat Functionality
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatContainer = document.getElementById('chat-container');
    const chatFileInput = document.getElementById('chat-file');
    const mediaPreview = document.getElementById('media-preview');
    const cancelMediaButton = document.getElementById('cancel-media');
    const clearChatButton = document.getElementById('clear-chat');

    const stopWords = ['–∏', '–≤', '–Ω–∞', '–ø–æ', '–ª–∏', '—ç—Ç–æ', '–∞', '–∫', '—É', '–∑–∞', '—Ç–æ', '–∂–µ', '–æ—Ç', '—Å', '–±–µ–∑'];
    
    // –î–ê–ù–ù–´–ï –ì–õ–£–ë–ò–ù–ù–û–ì–û –ü–†–û–§–û–†–ò–ï–ù–¢–ê–¶–ò–û–ù–ù–û–ì–û –¢–ï–°–¢–ê
    const deepCareerTest = {
      questions: [
        {
          "question": "1. –í–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Å—É–ø–µ—Ä—Å–∏–ª–∞ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ (—Å—Ä—ã–≤ –¥–µ–¥–ª–∞–π–Ω–∞, –∫—Ä–∏–∑–∏—Å –ø—Ä–æ–µ–∫—Ç–∞) –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ –≤—ã:",
          "options": {
            "analyst": "–•–ª–∞–¥–Ω–æ–∫—Ä–æ–≤–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é, —á—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –∏ —Å–æ—Å—Ç–∞–≤–ª—è—é –Ω–æ–≤—ã–π, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –ø–ª–∞–Ω.",
            "innovator": "–ù–∞—Ö–æ–∂—É –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π, –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –æ–±—Ö–æ–¥–Ω–æ–π –ø—É—Ç—å, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∏–∫—Ç–æ –Ω–µ –æ–∂–∏–¥–∞–ª.",
            "communicator": "–ë–µ—Ä—É –Ω–∞ —Å–µ–±—è —Ä–æ–ª—å –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—â–∏–∫–∞, —É–ª–∞–∂–∏–≤–∞—é –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –Ω–∞—Ö–æ–∂—É –∫–æ–º–ø—Ä–æ–º–∏—Å—Å.",
            "pragmatist": "–í–¥–æ—Ö–Ω–æ–≤–ª—è—é –∫–æ–º–∞–Ω–¥—É, –≤—Å–µ–ª—è—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏ –±–µ—Ä—É –Ω–∞ —Å–µ–±—è —Ä–æ–ª—å '–ª–æ–∫–æ–º–æ—Ç–∏–≤–∞'."
          }
        },
        {
          "question": "2. –ß—Ç–æ –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ –≤—ã–∑—ã–≤–∞–µ—Ç —É –≤–∞—Å –Ω–∞–∏–±–æ–ª—å—à–µ–µ —á—É–≤—Å—Ç–≤–æ —Ç—Ä–µ–≤–æ–≥–∏ –∏–ª–∏ –≤—ã–≥–æ—Ä–∞–Ω–∏—è –ø—Ä–∏ –º—ã—Å–ª–∏ –æ —Ä–∞–±–æ—Ç–µ?",
          "options": {
            "analyst": "–ü–æ–ª–Ω–∞—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —á–µ—Ç–∫–∏—Ö KPI –∏ —Ä–∞–∑–º—ã—Ç—ã–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏.",
            "innovator": "–ú–æ–Ω–æ—Ç–æ–Ω–Ω–æ—Å—Ç—å, —Ä—É—Ç–∏–Ω–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≥–æ–¥–∞–º–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∞–ª–≥–æ—Ä–∏—Ç–º.",
            "communicator": "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –±–æ–ª—å—à–æ–º —à—É–º–Ω–æ–º –∫–æ–ª–ª–µ–∫—Ç–∏–≤–µ, –±—ã—Ç—å '–Ω–∞ –ø—É–±–ª–∏–∫–µ'.",
            "pragmatist": "–î–∞–≤–ª–µ–Ω–∏–µ, –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è —Å—Ä–µ–¥–∞ –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –¥–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–≤–æ–µ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–æ."
          }
        },
        // ... –¥–æ–±–∞–≤—å—Ç–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ 28 –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ –≤–∞—à–µ–≥–æ Python –∫–æ–¥–∞
        {
          "question": "30. –ó–∞–∫–æ–Ω—á–∏—Ç–µ —Ñ—Ä–∞–∑—É: '–ò–¥–µ–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Äì —ç—Ç–æ —Ç–∞, –≥–¥–µ —è...'",
          "options": {
            "analyst": "'...–º–æ–≥—É –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ —Ä–µ—à–µ–Ω–∏–∏ —Å–ª–æ–∂–Ω—ã—Ö –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á.'",
            "innovator": "'...–≤–∏–∂—É –ø—Ä—è–º–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–≤–æ–µ–≥–æ —Ç—Ä—É–¥–∞ –∏ –µ–≥–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –º–∏—Ä.'",
            "communicator": "'...–æ–∫—Ä—É–∂–µ–Ω –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º–∏, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º–∏ –ª—é–¥—å–º–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –º—ã –¥–µ–ª–∞–µ–º –æ–±—â–µ–µ –¥–µ–ª–æ.'",
            "pragmatist": "'...–∏–º–µ—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –±—Ä–æ—Å–∞—Ç—å –≤—ã–∑–æ–≤ —Å–∞–º–æ–º—É —Å–µ–±–µ –∏ –≤—ã—Ö–æ–¥–∏—Ç—å –∏–∑ –∑–æ–Ω—ã –∫–æ–º—Ñ–æ—Ä—Ç–∞.'"
          }
        }
      ],
      types: {
        'analyst': {
          'name': '–ê–Ω–∞–ª–∏—Ç–∏–∫/–°—Ç—Ä–∞—Ç–µ–≥',
          'traits': ['–ª–æ–≥–∏–∫–∞', '—Å–∏—Å—Ç–µ–º–Ω–æ—Å—Ç—å', '–≥–ª—É–±–∏–Ω–∞ –∞–Ω–∞–ª–∏–∑–∞', '—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å', '–ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º'],
          'description': '–í—ã —Ü–µ–Ω–∏—Ç–µ –ø–æ—Ä—è–¥–æ–∫, –ª–æ–≥–∏–∫—É –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥. –í–∞–º –≤–∞–∂–Ω–æ –¥–æ–∫–æ–ø–∞—Ç—å—Å—è –¥–æ —Å—É—Ç–∏ –≤–µ—â–µ–π –∏ –ø–æ–Ω—è—Ç—å –≥–ª—É–±–∏–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –í—ã –º—ã—Å–ª–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.',
          'professions': ['–∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö', '–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å', '–∏–Ω–∂–µ–Ω–µ—Ä', '—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ü–û', '—Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç', '–∞—Ä—Ö–∏–≤–∞—Ä–∏—É—Å', '—Ä–µ—Å—Ç–∞–≤—Ä–∞—Ç–æ—Ä'],
          'work_env': '–°–ø–æ–∫–æ–π–Ω–∞—è –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≥–ª—É–±–æ–∫–æ–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏'
        },
        'innovator': {
          'name': '–°–æ–∑–∏–¥–∞—Ç–µ–ª—å/–ù–æ–≤–∞—Ç–æ—Ä', 
          'traits': ['–∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å', '–≥–∏–±–∫–æ—Å—Ç—å', '–∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å', '–≤–∏–¥–µ–Ω–∏–µ', '–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ—Å—Ç—å'],
          'description': '–í—ã - –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π, —Å–æ–∑–¥–∞—Ç–µ–ª—å –Ω–æ–≤–æ–≥–æ. –í–∞–º –≤–∞–∂–Ω–∞ —Å–≤–æ–±–æ–¥–∞ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å. –í—ã –≤–∏–¥–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ç–∞–º, –≥–¥–µ –¥—Ä—É–≥–∏–µ –≤–∏–¥—è—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.',
          'professions': ['–¥–∏–∑–∞–π–Ω–µ—Ä', '–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥', '–ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å', '—Ö—É–¥–æ–∂–Ω–∏–∫', '–ø–∏—Å–∞—Ç–µ–ª—å', '–∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä', '–º—É–∑—ã–∫–∞–Ω—Ç'],
          'work_env': '–°–≤–æ–±–æ–¥–Ω–∞—è —Å—Ä–µ–¥–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏'
        },
        'communicator': {
          'name': '–ö–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä/–ü–æ—Å—Ä–µ–¥–Ω–∏–∫',
          'traits': ['—ç–º–ø–∞—Ç–∏—è', '–¥–∏–ø–ª–æ–º–∞—Ç–∏—á–Ω–æ—Å—Ç—å', '–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ', '–≥–∞—Ä–º–æ–Ω–∏—è', '–ø–æ–¥–¥–µ—Ä–∂–∫–∞'],
          'description': '–í–∞—à–∞ —Å—Ç–∏—Ö–∏—è - –ª—é–¥–∏. –í—ã —É–º–µ–µ—Ç–µ –Ω–∞—Ö–æ–¥–∏—Ç—å –æ–±—â–∏–π —è–∑—ã–∫, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å –∏ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å. –î–ª—è –≤–∞—Å –≤–∞–∂–Ω—ã –æ—Ç–Ω–æ—à–µ–Ω–∏—è –≤ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–µ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã.',
          'professions': ['–º–µ–Ω–µ–¥–∂–µ—Ä', '–ø—Å–∏—Ö–æ–ª–æ–≥', '–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å', 'HR-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', '–∫–æ—É—á', '–ø—Å–∏—Ö–æ–ª–æ–≥-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç', '–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π'],
          'work_env': '–ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –∂–∏–≤–æ–µ –æ–±—â–µ–Ω–∏–µ'
        },
        'pragmatist': {
          'name': '–ü—Ä–∞–≥–º–∞—Ç–∏–∫/–†–µ–∞–ª–∏–∑–∞—Ç–æ—Ä',
          'traits': ['—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å', '–¥–µ–π—Å—Ç–≤–∏–µ', '–ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å', '—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', '—Ü–µ–ª–µ—É—É—Å—Ç—Ä–µ–º–ª–µ–Ω–Ω–æ—Å—Ç—å'],
          'description': '–í—ã –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è. –£–º–µ–µ—Ç–µ –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –∏–¥–µ–∏ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–ª–∞. –î–ª—è –≤–∞—Å –≤–∞–∂–µ–Ω –∏–∑–º–µ—Ä–∏–º—ã–π —É—Å–ø–µ—Ö –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–ª—å–∑–∞.',
          'professions': ['–ø—Ä–æ–µ–∫—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä', '–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä', '–±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫', '—Ç–æ—Ä–≥–æ–≤—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å', '–∏–Ω–∂–µ–Ω–µ—Ä-–∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å', '—Å—Ç–∞—Ä—Ç–∞–ø-–æ—Å–Ω–æ–≤–∞—Ç–µ–ª—å'],
          'work_env': '–î–∏–Ω–∞–º–∏—á–Ω–∞—è —Å—Ä–µ–¥–∞ —Å —á–µ—Ç–∫–∏–º–∏ —Ü–µ–ª—è–º–∏'
        }
      }
    };

    // –ë–ê–ó–ê –î–ê–ù–ù–´–• –£–ù–ò–í–ï–†–°–ò–¢–ï–¢–û–í –ö–ê–ó–ê–•–°–¢–ê–ù–ê
    const universities = {
      "kaznu": {
        name: "–ö–∞–∑–∞—Ö—Å–∫–∏–π –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –∏–º. –∞–ª—å-–§–∞—Ä–∞–±–∏ (KazNU / Farabi)",
        military: "–µ—Å—Ç—å (–≤–æ–µ–Ω–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –Ω–∞–±–æ—Ä –ø–æ –∫–æ–Ω–∫—É—Ä—Å—É)",
        scores: "–ø–æ—Ä–æ–≥–æ–≤—ã–µ –±–∞–ª–ª—ã –ï–ù–¢ –≤–∞—Ä—å–∏—Ä—É—é—Ç—Å—è –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º (–æ—Ç ~65 –∏ –≤—ã—à–µ)",
        budget: "–µ—Å—Ç—å –±—é–¥–∂–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∫–∞–∑–∞–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –±–∞–ª–ª–æ–≤",
        directions: "–≥—É–º–∞–Ω–∏—Ç–∞—Ä–Ω—ã–µ –Ω–∞—É–∫–∏, —Ñ–∏–ª–æ–ª–æ–≥–∏—è, —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞—É–∫–∏, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞—É–∫–∏, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –òT, —ç–∫–æ–Ω–æ–º–∏–∫–∞, —é—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏—è, –ø–µ–¥–∞–≥–æ–≥–∏–∫–∞",
        aliases: ["–∫–∞–∑–Ω—É", "farabi", "–∞–ª—å-—Ñ–∞—Ä–∞–±–∏", "–∫–∞–∑–∞—Ö—Å–∫–∏–π –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç"]
      },
      // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã
    };

    // –†–ê–°–®–ò–†–ï–ù–ù–´–ô FAQ –î–õ–Ø –ü–†–û–§–û–†–ò–ï–ù–¢–ê–¶–ò–ò
    const faq = [
      {
        keywords: ['–ø—Ä–æ—Ñ–µ—Å—Å–∏—è', '–ø—Ä–æ—Ñ–µ—Å—Å–∏–∏', '–∫–µ–º —Å—Ç–∞—Ç—å', '–≤—ã–±–æ—Ä –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏', '–∫–∞—Ä—å–µ—Ä–∞', '–ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è', '–±—É–¥—É—â–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏—è', '—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å', '–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä', '–∫–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å', '–∫–∞–∫—É—é –ø—Ä–æ—Ñ–µ—Å—Å–∏—é –≤—ã–±—Ä–∞—Ç—å', '–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–∞–º–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ', '–≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏—é', '–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–µ–π', '–±—É–¥—É—â–∞—è —Ä–∞–±–æ—Ç–∞', '–∫–∞—Ä—å–µ—Ä–Ω—ã–π –ø—É—Ç—å', '–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å'],
        answer: '–ù–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ NeXus –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π –∏ –æ—Ü–µ–Ω–æ–∫. –ú—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–∏ —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤–∞–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã –∏ –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω—ã –Ω–∞ —Ä—ã–Ω–∫–µ —Ç—Ä—É–¥–∞.'
      },
      {
        keywords: ['—Ç–µ—Å—Ç', '—Ç–µ—Å—Ç—ã', '–ø—Ä–æ—Ñ—Ç–µ—Å—Ç', '–ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π', '–ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç', '–æ–ø—Ä–æ—Å', '–∞–Ω–∫–µ—Ç–∞', '–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞', '—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', '–ø—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å', '–ø—Ä–æ–π—Ç–∏ –∞–Ω–∫–µ—Ç—É', '–ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç', '—Ç–µ—Å—Ç –Ω–∞ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é', '—Ç–µ—Å—Ç –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é', '–ø—Ä–æ–π—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É', '—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π', '–æ–ø—Ä–æ—Å–Ω–∏–∫', '–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç'],
        answer: '–í —Ä–∞–∑–¥–µ–ª–µ "–¢–µ—Å—Ç—ã" –¥–æ—Å—Ç—É–ø–Ω—ã —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã. –ü–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º –æ–±—É—á–µ–Ω–∏—è. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–π—Ç–∏ –≥–ª—É–±–∏–Ω–Ω—ã–π –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å? –ù–∞–ø–∏—à–∏—Ç–µ "–ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç" –∏–ª–∏ "–Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ".'
      },
      {
        keywords: ['–ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç', '–Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç', '–Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', '–ø—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å', '–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç', '–Ω–∞—á–∞—Ç—å –ø—Ä–æ—Ñ—Ç–µ—Å—Ç', '–ø—Ä–æ–π—Ç–∏ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é', '–Ω–∞—á–∞—Ç—å –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é', '—Ö–æ—á—É —Ç–µ—Å—Ç', '–º–æ–∂–Ω–æ —Ç–µ—Å—Ç', '–¥–∞–≤–∞–π —Ç–µ—Å—Ç', '–ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π –º–µ–Ω—è', '–ø—Ä–æ–≤–µ–¥–∏ —Ç–µ—Å—Ç', '—Å–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç', '–ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É', '—Ç–µ—Å—Ç–∏—Ä—É–π'],
        answer: 'test' // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞
      },
      // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π FAQ
    ];

    const defaultReply = '–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å –æ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∏–ª–∏ –≤—ã–±–æ—Ä–µ –≤—É–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ "–ü–æ–∑–≤–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞" –¥–ª—è —Å–≤—è–∑–∏ —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º. –ú–æ–∂–µ—Ç–µ —Ç–∞–∫–∂–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ —Å–≤–æ–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö - —è –ø–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏!';

    let currentUniversityContext = null;
    let currentTestState = {
      inProgress: false,
      currentQuestion: 0,
      answers: [],
      scores: { analyst: 0, innovator: 0, communicator: 0, pragmatist: 0 }
    };

    let pendingMedia = [];

    // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ì–õ–£–ë–ò–ù–ù–û–ì–û –¢–ï–°–¢–ê
    function startDeepCareerTest() {
      currentTestState = {
        inProgress: true,
        currentQuestion: 0,
        answers: [],
        scores: { analyst: 0, innovator: 0, communicator: 0, pragmatist: 0 }
      };
      showDeepTestQuestion(0);
    }

    function showDeepTestQuestion(questionIndex) {
      const question = deepCareerTest.questions[questionIndex];
      const testMessage = document.createElement('div');
      testMessage.className = 'message bot-message animate-fade-in';
      
      const progressPercent = ((questionIndex) / deepCareerTest.questions.length) * 100;
      
      let html = `<div class="test-container">
        <div class="test-progress">
          <div class="test-progress-bar" style="width: ${progressPercent}%"></div>
        </div>
        <div class="test-question">${question.question}</div>`;
      
      Object.entries(question.options).forEach(([type, option]) => {
        html += `<button class="test-option" onclick="handleDeepTestAnswer('${type}')">${option}</button>`;
      });
      
      html += `<div style="text-align: center; margin-top: 1rem; color: var(--color-text-secondary); font-size: 0.8rem;">
        –í–æ–ø—Ä–æ—Å ${questionIndex + 1} –∏–∑ ${deepCareerTest.questions.length}
      </div></div>`;
      
      testMessage.innerHTML = html;
      chatContainer.appendChild(testMessage);
      chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
    }

    function handleDeepTestAnswer(answerType) {
      currentTestState.scores[answerType]++;
      currentTestState.currentQuestion++;
      
      if (currentTestState.currentQuestion < deepCareerTest.questions.length) {
        showDeepTestQuestion(currentTestState.currentQuestion);
      } else {
        finishDeepTest();
      }
    }

    function finishDeepTest() {
      const results = calculateDeepTestResults();
      const resultMessage = document.createElement('div');
      resultMessage.className = 'message bot-message animate-fade-in';
      
      let html = `<div class="test-results">
        <h3 style="margin: 0 0 1rem 0; font-size: 1.3rem;">üéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:</h3>
        ${generateResultsHTML(results)}
        <div style="margin-top: 1.5rem;">
          <button class="university-button" onclick="showUniversityRecommendations('${results.dominantType}')" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
            üè´ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –≤—É–∑—ã
          </button>
          <button class="university-button" onclick="startNewChat()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
            üîÑ –ù–æ–≤—ã–π —Ç–µ—Å—Ç
          </button>
        </div>
      </div>`;
      
      resultMessage.innerHTML = html;
      chatContainer.appendChild(resultMessage);
      
      currentTestState.inProgress = false;
      chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
    }

    function calculateDeepTestResults() {
      const percentages = {};
      const total = Object.values(currentTestState.scores).reduce((a, b) => a + b, 0);
      
      Object.entries(currentTestState.scores).forEach(([type, score]) => {
        percentages[type] = total > 0 ? Math.round((score / total) * 100) : 0;
      });
      
      // –ù–∞—Ö–æ–¥–∏–º –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —Ç–∏–ø
      const sortedTypes = Object.entries(percentages).sort((a, b) => b[1] - a[1]);
      const dominantType = sortedTypes[0][0];
      
      return {
        percentages,
        dominantType,
        dominantPercent: sortedTypes[0][1],
        sortedTypes
      };
    }

    function generateResultsHTML(results) {
      let html = '';
      
      results.sortedTypes.forEach(([type, percent]) => {
        const typeInfo = deepCareerTest.types[type];
        html += `
          <div class="test-type-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <strong>${typeInfo.name}</strong>
              <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 1rem; font-size: 0.8rem;">
                ${percent}%
              </span>
            </div>
            <div style="font-size: 0.9rem; opacity: 0.9;">
              ${typeInfo.description}
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.8rem;">
              <strong>–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏:</strong> ${typeInfo.professions.slice(0, 3).join(', ')}
            </div>
          </div>
        `;
      });
      
      // –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
      const domInfo = deepCareerTest.types[results.dominantType];
      let analysis = '';
      
      if (results.dominantPercent >= 60) {
        analysis = `üí™ –£ –≤–∞—Å —è—Ä–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å <strong>${domInfo.name}</strong> —Å —á–µ—Ç–∫–∏–º–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º–∏.`;
      } else if (results.dominantPercent >= 40) {
        analysis = `‚öñÔ∏è –£ –≤–∞—Å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Å –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–º–∏ —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—è–º–∏ –∫ <strong>${domInfo.name}</strong>, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—â–∏–π –≥–∏–±–∫–æ—Å—Ç—å.`;
      } else {
        analysis = `üé≠ –£ –≤–∞—Å –º–Ω–æ–≥–æ–≥—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Å —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏. –ù–∞–∏–±–æ–ª—å—à–∞—è —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ <strong>${domInfo.name}</strong>.`;
      }
      
      html = `<div style="margin-bottom: 1rem;">${analysis}</div>` + html;
      return html;
    }

    function showUniversityRecommendations(profileType) {
      const recommendations = getUniversityRecommendations(profileType);
      const recMessage = document.createElement('div');
      recMessage.className = 'message bot-message animate-fade-in';
      
      let html = `<div class="test-container">
        <h4 style="margin: 0 0 1rem 0;">üè´ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –≤—É–∑—ã –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">`;
      
      recommendations.forEach(uniKey => {
        const uni = universities[uniKey];
        html += `<button class="university-button" onclick="handleUniversitySelect('${uniKey}', 'all')">${uni.name.split('(')[0].trim()}</button>`;
      });
      
      html += `</div></div>`;
      recMessage.innerHTML = html;
      chatContainer.appendChild(recMessage);
      chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
    }

    function getUniversityRecommendations(profileType) {
      const recommendations = {
        'analyst': ['kaznu', 'satbayev', 'kbtu'],
        'innovator': ['alma', 'kbtu', 'dku'],
        'communicator': ['abai', 'abylai', 'alma'],
        'pragmatist': ['kbtu', 'atu', 'aues']
      };
      return recommendations[profileType] || ['kaznu', 'kbtu', 'alma'];
    }

    // –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ß–ê–¢–ê (findAnswer, handleChatSubmit –∏ —Ç.–¥.)
    function findAnswer(message) {
      const words = message
        .toLowerCase()
        .split(/[^a-z–∞-—è—ë0-9—ë]+/i)
        .filter(w => w && !stopWords.includes(w));
      let best = { answer: defaultReply, score: 0 };
      
      faq.forEach(item => {
        const score = item.keywords.reduce(
          (sum, kw) => words.includes(kw) ? sum + 1 : sum,
          0
        );
        if (score > best.score) best = { answer: item.answer, score };
      });

      if (best.answer === 'test') {
        startDeepCareerTest();
        return '';
      }

      return best.answer;
    }

    function createNewChat() {
      chatContainer.innerHTML = '';
      currentTestState = {
        inProgress: false,
        currentQuestion: 0,
        answers: [],
        scores: { analyst: 0, innovator: 0, communicator: 0, pragmatist: 0 }
      };
      currentUniversityContext = null;
      
      const welcomeMsg = document.createElement('div');
      welcomeMsg.className = 'message bot-message animate-fade-in';
      welcomeMsg.innerHTML = `
        <div class="test-container">
          <h3 style="margin: 0 0 1rem 0;">üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ NeXus!</h3>
          <p>–Ø –ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏. –ü–æ–º–æ–≥—É –≤–∞–º:</p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li>–ü—Ä–æ–π—Ç–∏ –≥–ª—É–±–∏–Ω–Ω—ã–π –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç</li>
            <li>–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</li>
            <li>–ü–æ–¥–æ–±—Ä–∞—Ç—å –≤—É–∑—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞</li>
            <li>–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏</li>
          </ul>
          <button class="test-option" onclick="startDeepCareerTest()" style="background: var(--color-primary); color: white; text-align: center;">
            üöÄ –ù–∞—á–∞—Ç—å –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç (30 –≤–æ–ø—Ä–æ—Å–æ–≤)
          </button>
        </div>
      `;
      chatContainer.appendChild(welcomeMsg);
      
      chatInput.value = '';
      clearMediaPreview();
      chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
    }

    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏
    window.handleDeepTestAnswer = handleDeepTestAnswer;
    window.handleUniversitySelect = handleUniversitySelect;
    window.showUniversityRecommendations = showUniversityRecommendations;
    window.startDeepCareerTest = startDeepCareerTest;
    window.startNewChat = createNewChat;

    // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ–¥–∏–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ä–º...
    function clearMediaPreview() {
      pendingMedia = [];
      mediaPreview.innerHTML = '';
      mediaPreview.classList.add('hidden');
      cancelMediaButton.classList.add('hidden');
    }

    function handleFileInput(e) {
      const files = e.target.files;
      if (files.length) {
        Array.from(files).forEach(file => {
          if (!file.type.startsWith('image/')) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            return;
          }
          const reader = new FileReader();
          reader.onload = (event) => {
            pendingMedia.push(event.target.result);
            updateMediaPreview();
          };
          reader.readAsDataURL(file);
        });
        e.target.value = '';
      }
    }

    function updateMediaPreview() {
      mediaPreview.innerHTML = '';
      pendingMedia.forEach((media, index) => {
        const div = document.createElement('div');
        div.className = 'media-preview-item';
        div.innerHTML = `
          <img src="${media}" alt="Preview">
          <button data-index="${index}" type="button"><i class="fas fa-times"></i></button>
        `;
        mediaPreview.appendChild(div);
        div.querySelector('button').addEventListener('click', () => {
          pendingMedia.splice(index, 1);
          updateMediaPreview();
        });
      });
      mediaPreview.classList.toggle('hidden', pendingMedia.length === 0);
      cancelMediaButton.classList.toggle('hidden', pendingMedia.length === 0);
    }

    function handleChatSubmit(e) {
      e.preventDefault();
      e.stopPropagation();

      const message = chatInput.value.trim();
      const hasMedia = pendingMedia.length > 0;

      if (!message && !hasMedia) return;

      if (currentTestState.inProgress) {
        const userMsg = document.createElement('div');
        userMsg.className = 'message user-message animate-fade-in';
        userMsg.textContent = message;
        chatContainer.appendChild(userMsg);
        
        const botMsg = document.createElement('div');
        botMsg.className = 'message bot-message animate-fade-in';
        botMsg.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–∏—Ä–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—ã —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–æ–∫ –≤—ã—à–µ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.';
        chatContainer.appendChild(botMsg);
        
        chatInput.value = '';
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        return;
      }

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (message) {
        const userMsg = document.createElement('div');
        userMsg.className = 'message user-message animate-fade-in';
        userMsg.textContent = message;
        chatContainer.appendChild(userMsg);
      }

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞
      if (hasMedia) {
        pendingMedia.forEach(media => {
          const mediaMsg = document.createElement('div');
          mediaMsg.className = 'message message-image user-message animate-fade-in';
          mediaMsg.innerHTML = `<img src="${media}" alt="Sent image">`;
          chatContainer.appendChild(mediaMsg);
        });
      }

      chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });

      // –û—á–∏—Å—Ç–∫–∞ –∏ –æ—Ç–≤–µ—Ç
      chatInput.value = '';
      clearMediaPreview();

      setTimeout(() => {
        const answer = findAnswer(message);
        if (answer) {
          const botMsg = document.createElement('div');
          botMsg.className = 'message bot-message animate-fade-in';
          botMsg.textContent = answer;
          chatContainer.appendChild(botMsg);
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }
      }, 500);
    }

    // Event listeners
    chatFileInput.addEventListener('change', handleFileInput);
    cancelMediaButton.addEventListener('click', clearMediaPreview);
    chatForm.addEventListener('submit', handleChatSubmit);
    clearChatButton.addEventListener('click', createNewChat);

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleChatSubmit(e);
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    createNewChat();
  });
</script>
{% endblock %}