{% extends "base.html" %}
{% load static %}
{% block title %}NeXus — Чат с ИИ-консультантом{% endblock %}

{% block extra_head %}>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    :root {
      --color-primary: #007AFF;
      --color-bg: #F5F5F7;
      --color-bg-secondary: #FFFFFF;
      --color-text: #1D1D1F;
      --color-text-secondary: #6E6E73;
      --color-border: #D2D2D7;
      --color-shadow: rgba(0, 0, 0, 0.08);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', sans-serif;
      background-color: var(--color-bg);
      color: var(--color-text);
      line-height: 1.5;
      overflow-wrap: anywhere;
    }
    button, a, input { transition: all 0.3s ease; }
        .contact-page-container {
      width: min(100%, 900px);
      margin-inline: auto;
      padding: clamp(1.5rem, 4vw, 2.5rem) clamp(1rem, 4vw, 3rem) clamp(2rem, 6vw, 4rem);
      min-height: calc(100vh - 3rem);
      display: flex;
      flex-direction: column;
    }
    @media (max-width: 640px) {
      .contact-page-container {
        padding: 1rem;
        min-height: 100vh;
      }
    }
    .contact-chat-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid var(--color-border);
      border-radius: 18px;
      box-shadow: 0 4px 30px var(--color-shadow);
    }
    .contact-chat-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      height: min(850px, calc(100vh - 8rem));
      overflow: hidden;
      width: 100%;
    }
    @media (min-width: 768px) {
      .contact-chat-card {
        margin-inline: auto;
        width: min(100%, 760px);
      }      
    }
    @media (max-width: 1024px) {
      .contact-chat-card {
        height: auto;
      }
    }
    #chat-container {
      min-height: 0;
      max-height: calc(100vh - 220px);
      overflow-y: auto;
      padding-right: 0.25rem;
      scroll-behavior: smooth;
      overscroll-behavior: contain;
    }
    #chat-container::-webkit-scrollbar {
      width: 8px;
    }
    #chat-container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
    }
    #chat-container::-webkit-scrollbar-thumb {
      background: var(--color-primary);
      border-radius: 8px;
    }   
    button:hover, a:hover { transform: translateY(-1px); }
    .message {
      max-width: 75%;
      padding: 0.75rem 1.25rem;
      border-radius: 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .animate-fade-in { animation: fade-in 0.3s ease forwards; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .user-message {
      align-self: flex-end;
      background: var(--color-primary);
      color: #fff;
      border-bottom-right-radius: 0.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .bot-message {
      align-self: flex-start;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      color: var(--color-text);
      border-bottom-left-radius: 0.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .message-image {
      max-width: 50%;
      padding: 0.25rem;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
    }
    .message-image img { width: 100%; border-radius: 0.5rem; }
    .media-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 0.5rem;
      overflow: hidden;
      border: 1px solid var(--color-border);
    }
    .media-preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .media-preview-item button {
      position: absolute;
      top: 0.25rem;
      right: 0.25rem;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .media-preview-item button:hover { background: rgba(0, 0, 0, 0.7); }
    @keyframes slide-in { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .animate-slide-in { animation: slide-in 0.3s ease; }
    .test-option {
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      margin: 0.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .test-option:hover { background: #0051CC; transform: translateY(-2px); }
    .test-question {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .university-button {
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }
    .university-button:hover { background: #0051CC; transform: translateY(-1px); }
    .profession-button {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }
    .profession-button:hover { background: #218838; transform: translateY(-1px); }
    .recommendation-button {
      background: #ff6b35;
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      margin: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      font-weight: bold;
    }
    .recommendation-button:hover { background: #e55a2b; transform: translateY(-2px); }
    .university-card {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 1rem;
      padding: 1rem;
      margin: 0.5rem 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .university-link {
      display: inline-block;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    .university-link:hover { background: #0051CC; transform: translateY(-1px); }
  </style>
{% endblock %}

{% block content %}
  <div class="contact-page-container">
    <div class="contact-chat-wrapper">
      <h1 class="text-3xl font-semibold tracking-tight mb-6 sm:mb-8">Чат с ИИ-консультантом по профориентации</h1>
      <div class="card flex flex-col contact-chat-card">
      <div id="chat-container" class="flex-1 p-4 space-y-3 bg-[var(--color-bg)] flex flex-col">
        <!-- Messages will be loaded here -->
      </div>
      <div class="p-4 border-t border-[var(--color-border)]">
        <div id="media-preview" class="hidden flex gap-2 mb-4 flex-wrap"></div>
        <form id="chat-form" class="flex gap-2" style="flex-wrap: wrap;">
          <input type="text" id="chat-input" placeholder="Задайте вопрос о профессиях, вузах или профориентации..." class="flex-grow min-w-[150px] border border-[var(--color-border)] rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]" />
          <label for="chat-file" class="cursor-pointer text-[var(--color-primary)] hover:underline flex items-center px-3 shrink-0" title="Прикрепить изображение">
            <i class="fas fa-paperclip"></i>
          </label>
          <input type="file" id="chat-file" accept="image/*" style="display:none" multiple />
          <button id="cancel-media" type="button" class="bg-red-500 text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-red-600 shadow-sm hidden">Отмена</button>
          <button type="submit" class="bg-[var(--color-primary)] text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-[#0051CC] shadow-sm">Отправить</button>
          <button type="button" id="clear-chat" class="bg-gray-500 text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-gray-600 shadow-sm">Новый чат</button>
        </form>
      </div>
    </div>
   </div>
  </div>
{% endblock %}

{% block extra_scripts %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // Chat Functionality
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');
      const chatContainer = document.getElementById('chat-container');
      const chatFileInput = document.getElementById('chat-file');
      const mediaPreview = document.getElementById('media-preview');
      const cancelMediaButton = document.getElementById('cancel-media');
      const clearChatButton = document.getElementById('clear-chat');

      const stopWords = ['и', 'в', 'на', 'по', 'ли', 'это', 'а', 'к', 'у', 'за', 'то', 'же', 'от', 'с', 'без'];
      
      // БАЗА ДАННЫХ УНИВЕРСИТЕТОВ КАЗАХСТАНА
      const universities = {
        "kaznu": {
          name: "Казахский национальный университет им. аль-Фараби (KazNU / Farabi)",
          military: "есть (военная подготовка, набор по конкурсу)",
          scores: "пороговые баллы ЕНТ варьируются по программам (от ~65 и выше)",
          budget: "есть бюджетные места, количество указано в таблицах пороговых баллов",
          directions: "гуманитарные науки, филология, социальные науки, естественные науки, математика, ИT, экономика, юриспруденция, педагогика",
          aliases: ["казну", "farabi", "аль-фараби", "казахский национальный университет"],
          url: "/universities/kaznu/",
          description: "Ведущий классический университет Казахстана с сильными научными школами и международными программами.",
          strengths: ["Фундаментальные науки", "Международные программы", "Научные исследования"],
          image: "https://upload.wikimedia.org/wikipedia/commons/a/a1/Al-Farabi_Kazakh_National_University_main_building.jpg"
        },
        "abai": {
          name: "Казахский национальный педагогический университет им. Абая (Abai University)",
          military: "есть (отбор на конкурсной основе)",
          scores: "для педагогических направлений часто выше (от ~70), для других от ~65",
          budget: "есть бюджетные места, публикуются по группам образовательных программ",
          directions: "педагогика, дошкольное и школьное образование, методики преподавания, физкультура, музыка, искусство",
          aliases: ["абай", "abai", "казахский педагогический", "кзнпу"],
          url: "/universities/kaznpu/",
          description: "Главный педагогический университет страны с богатой историей подготовки учителей и методистов.",
          strengths: ["Педагогическое образование", "Методики преподавания", "Психология"],
          image: "https://upload.wikimedia.org/wikipedia/commons/5/56/Akhmet_Baitursynuly_Street_13_Almaty_02.jpg"
        },
        "satbayev": {
          name: "Satbayev University (Сатбаев)",
          military: "есть (приём на кафедру проводится на конкурсной основе)",
          scores: "минимум для конкурса грантов от 65 баллов",
          budget: "есть бюджетные места по программам",
          directions: "инженерия, IT, математика, информационные системы, информационная безопасность, компьютерные науки",
          aliases: ["сатбаев", "satbayev", "сатпаев"],
          url: "/universities/satbayev/",
          description: "Инженерно-технический лидер региона с акцентом на цифровые технологии и партнерство с индустрией.",
          strengths: ["Инженерия", "IT технологии", "Технические науки"],
          image: "https://upload.wikimedia.org/wikipedia/commons/0/0f/Kazakh-British_Technical_University.jpg"
        },
        "kaznmu": {
          name: "Казахский национальный медицинский университет им. С.Д. Асфендиярова (KazNMU)",
          military: "есть (правила приёма на военную кафедру)",
          scores: "высокие баллы (часто >110 в зависимости от программы)",
          budget: "есть бюджетные места по специальностям",
          directions: "медицина (лечебное дело), педиатрия, стоматология, фармация, сестринское дело, общественное здоровье",
          aliases: ["казнму", "медицинский", "асфендияров"],
          url: "/universities/kaznmu/",
          description: "Крупнейший медицинский вуз Казахстана с современной клинической базой и симуляционными центрами.",
          strengths: ["Медицина", "Клиническая практика", "Фармация"],
          image: "https://upload.wikimedia.org/wikipedia/commons/4/4f/S.D._Asfendiyarov_Kazakh_National_Medical_University.jpg"
        },
        "abylai": {
          name: "Казахский университет международных отношений и мировых языков им. Абылай хана (KazUIR)",
          military: "информация опубликована на сайте (см. раздел «Абитуриентам»)",
          scores: "разные по программам, публикуются на сайте",
          budget: "есть бюджетные места, публикуются ежегодно",
          directions: "международные отношения, дипломатия, лингвистика, регионоведение, перевод, политология",
          aliases: ["абылай", "abylai", "казахский университет международных отношений"],
          url: "/universities/kazumo/",
          description: "Специализируется на международных отношениях, переводе и глобальной коммуникации.",
          strengths: ["Международные отношения", "Лингвистика", "Дипломатия"],
          image: "https://upload.wikimedia.org/wikipedia/commons/2/27/Ablai_Khan_University.jpg"
        },
        "kbtu": {
          name: "Казахстанско-Британский технический университет (KBTU)",
          military: "есть (набор на военную кафедру)",
          scores: "высокий конкурс (100+ или 110+ для популярных направлений)",
          budget: "есть бюджетные места по программам",
          directions: "инженерия, IT, менеджмент в технических сферах, химинжиниринг, материалы, электроника, финансы",
          aliases: ["кбту", "kbtu", "британский технический"],
          url: "#",
          description: "Технический вуз с британской системой образования и акцентом на практические навыки.",
          strengths: ["Техническое образование", "Международные стандарты", "Практическая подготовка"],
          image: "https://kbtu.edu.kz/images/2022/09/01/1.jpg"
        },
        "dku": {
          name: "Казахстанско-Немецкий университет (DKU)",
          military: "информация на официальном сайте",
          scores: "пороги зависят от группы образовательных программ",
          budget: "есть гранты и квоты (частный/международный вуз)",
          directions: "менеджмент, международное сотрудничество, инженерные программы с немецкой компонентой, языки, бизнес-образование",
          aliases: ["дку", "dku", "немецкий университет"],
          url: "/universities/german/",
          description: "Мост между Казахстаном и Европой с программами на немецком и английском языках.",
          strengths: ["Международные программы", "Немецкий язык", "Бизнес-образование"],
          image: "https://dku.kz/assets/files/000/000/378/original/DSC_3159.jpg"
        },
        "atu": {
          name: "Алматинский технологический университет (АТУ)",
          military: "есть (набор на военную подготовку)",
          scores: "пороги по прграммам (от ~45–65 и выше)",
          budget: "есть бюджетные места",
          directions: "пищевая промышленность, текстиль, технологии, инженерные специальности, IT, экономика, туризм и сервис",
          aliases: ["ату", "atu", "алматинский технологический"],
          url: "/universities/technological/",
          description: "Лидер в сфере пищевых технологий, дизайна и лёгкой промышленности.",
          strengths: ["Пищевые технологии", "Дизайн", "Легкая промышленность"],
          image: "https://tengrinews.kz/userdata/news/2017/news_326837/thumb_m/photo_219423.png"
        }
      };

      // РАСШИРЕННЫЙ FAQ ДЛЯ ПРОФОРИЕНТАЦИИ
      const faq = [
        {
          keywords: ['профессия', 'профессии', 'кем стать', 'выбор профессии', 'карьера', 'профориентация', 'будущая профессия', 'специальность', 'профессиональный выбор', 'кем работать', 'какую профессию выбрать', 'профессиональное самоопределение', 'выбрать профессию', 'определиться с профессией', 'будущая работа', 'карьерный путь', 'профессиональная деятельность'],
          answer: 'На платформе NeXus вы можете пройти профориентационные тесты, которые помогут определить подходящие профессии на основе ваших интересов, способностей и оценок. Мы анализируем ваши склонности и предлагаем профессии, которые будут вам интересны и востребованы на рынке труда.'
        },
        {
          keywords: ['тест', 'тесты', 'профтест', 'профориентационный', 'пройти тест', 'опрос', 'анкета', 'диагностика', 'тестирование', 'пройти опрос', 'пройти анкету', 'профориентационный тест', 'тест на профориентацию', 'тест на профессию', 'пройти диагностику', 'тестирование способностей', 'опросник', 'психологический тест'],
          answer: 'В разделе "Тесты" доступны различные профориентационные тесты. После прохождения вы получите персональные рекомендации по профессиям и направлениям обучения. Хотите пройти быстрый тест прямо сейчас? Напишите "пройти тест" или "начать тестирование".'
        },
        {
          keywords: ['пройти тест', 'начать тест', 'начать тестирование', 'пройти опрос', 'запустить тест', 'начать профтест', 'пройти профориентацию', 'начать профориентацию', 'хочу тест', 'можно тест', 'давай тест', 'протестируй меня', 'проведи тест', 'сделать тест', 'пройти проверку', 'тестируй'],
          answer: 'test' // Специальный маркер для запуска теста
        },
        {
          keywords: ['военная кафедра', 'военка', 'армия', 'военная подготовка', 'военное дело', 'военную', 'кафедра', 'военную подготовку', 'служба', 'отсрочка'],
          answer: 'military' // Специальный маркер для вопроса о военной кафедре
        },
        {
          keywords: ['баллы', 'проходной балл', 'ент', 'экзамен', 'результаты', 'минимальный балл', 'вступительные', 'баллы ент', 'средний балл', 'проходные баллы', 'баллы для поступления', 'минимальные баллы', 'требуемые баллы', 'результаты экзаменов', 'вступительные испытания', 'экзаменационные баллы', 'пороговый'],
          answer: 'scores' // Специальный маркер для вопроса о баллах
        },
        {
          keywords: ['бюджет', 'грант', 'стипендия', 'бюджетное', 'бесплатное', 'обучение', 'финансирование', 'стоимость', 'цена', 'бюджетное место', 'контракт', 'оплата обучения', 'стоимость обучения', 'бесплатное обучение', 'гранты на обучение', 'образовательные гранты', 'стипендии для студентов', 'финансовая помощь'],
          answer: 'budget' // Специальный маркер для вопроса о бюджете
        },
        {
          keywords: ['направления', 'специальности', 'факультеты', 'программы', 'образование', 'обучение', 'что изучать', 'какие направления', 'специальность', 'факультет', 'образовательная программа'],
          answer: 'directions'
        },
        {
          keywords: ['университет', 'университета', 'вузы', 'вуз', 'универ', 'университеты', 'университетов', 'колледж', 'институт', 'учебное заведение'],
          answer: 'university'
        },
        {
          keywords: ['спасибо', 'благодарю', 'благодарю вас', 'спасибо большое', 'благодарен', 'все понятно', 'понял', 'ясно', 'круто'],
          answer: 'Рад помочь! Если появятся ещё вопросы о профессиях или университетах — пишите.'
        },
        {
          keywords: ['привет', 'здравствуйте', 'добрый день', 'добрый вечер', 'доброе утро', 'хай', 'hello', 'hi'],
          answer: 'Здравствуйте! Чем могу помочь в выборе профессии или университета?'
        }
      ];

      const defaultReply = 'Не совсем понял ваш вопрос о профориентации или выборе вуза. Попробуйте переформулировать или напишите "Позвать консультанта" для связи со специалистом. Можете также рассказать о своих интересах - я помогу подобрать профессии!';

      // РАСШИРЕННЫЕ ДАННЫЕ ДЛЯ ПРОФОРИЕНТАЦИОННОГО ТЕСТА
      const proforientationTest = [
        {
          question: "1. Ваша главная суперсила в критической ситуации (срыв дедлайна, кризис проекта) проявляется в том, что вы:",
          options: {
            analyst: "Хладнокровно анализирую, что пошло не так, и составляю новый, реалистичный план.",
            innovator: "Нахожу нестандартный, креативный обходной путь, которого никто не ожидал.",
            communicator: "Беру на себя роль переговорщика, улаживаю конфликты и нахожу компромисс.",
            pragmatist: "Вдохновляю команду, вселяю уверенность и беру на себя роль 'локомотива'."
          }
        },
        {
          question: "2. Что из перечисленного вызывает у вас наибольшее чувство тревоги или выгорания при мысли о работе?",
          options: {
            analyst: "Полная неопределенность, отсутствие четких KPI и размытые обязанности.",
            innovator: "Монотонность, рутина, необходимость годами выполнять один и тот же алгоритм.",
            communicator: "Необходимость постоянно работать в большом шумном коллективе, быть 'на публике'.",
            pragmatist: "Давление, агрессивная конкурентная среда и постоянная необходимость доказывать свое превосходство."
          }
        },
        {
          question: "3. Представьте, что вы достигли вершины успеха в своей профессии. Что для вас означает эта 'вершина'?",
          options: {
            analyst: "Мое имя ассоциируется с фундаментальным открытием или изобретением.",
            innovator: "Я создал компанию/бренд, который работает и приносит пользу без моего постоянного вмешательства.",
            communicator: "Я являюсь непререкаемым авторитетом, гуру, к мнению которого прислушивается вся отрасль.",
            pragmatist: "Мое состояние позволяет мне и моей семье жить так, как мы хотим, и заниматься благотворительностью."
          }
        },
        {
          question: "4. Вспомните момент, когда вы почувствовали настоящее профессиональное удовлетворение. С чем оно было связано?",
          options: {
            analyst: "'Я разобрался в этой невероятно сложной штуке и наконец-то все понял'.",
            innovator: "'Мне удалось придумать то, до чего никто не додумался – уникальную метафору, дизайн, стратегию'.",
            communicator: "'Мы смогли это сделать только потому, что я сумел найти подход к этим сложным людям'.",
            pragmatist: "'Я увидел реальный, осязаемый результат своего труда – построил, написал, создал'."
          }
        },
        {
          question: "5. Какой тип обратной связи для вас наиболее ценен (даже если она критическая)?",
          options: {
            analyst: "Конкретная, по делу, с цифрами и фактами: 'Здесь ошибка, потому что...'.",
            innovator: "Оценка уникальности: 'Это свежий взгляд, но его можно сделать еще более смелым'.",
            communicator: "Личностно ориентированная: 'Мне нравится твоя энергия, но в этот раз ты был не до конца вовлечен'.",
            pragmatist: "Оценка общего вклада: 'Благодаря твоей работе мы продвинулись к цели...'."
          }
        },
        {
          question: "6. Ваше отношение к правилам и инструкциям:",
          options: {
            analyst: "Они существуют для эффективности. Я их соблюдаю, но если вижу, что правило устарело – выступаю за его изменение.",
            innovator: "Воспринимаю как вызов. Часто задаюсь вопросом 'а что, если сделать иначе?' и нарушаю, если уверен в своей правоте.",
            communicator: "Это основа порядка. Мне комфортно, когда все понятно, предсказуемо и регламентировано.",
            pragmatist: "Это инструмент для достижения цели. Я соблюдаю их, только если это помогает мне в конкретной ситуации."
          }
        },
        {
          question: "7. Как вы предпочитаете восстанавливать силы после тяжелого рабочего дня?",
          options: {
            analyst: "В одиночестве: за книгой, видеоигрой, прогулкой в тишине, хобби.",
            innovator: "Переключаясь на другой вид творческой или интеллектуальной деятельности.",
            communicator: "В общении с близкими или друзьями, за разговором по душам или веселыми мероприятиями.",
            pragmatist: "Через физическую активность: спорт, ремонт, работа по дому, танцы."
          }
        },
        {
          question: "8. Если бы вам гарантировали финансовый успех в любом случае, какую работу вы бы выбрали?",
          options: {
            analyst: "Реставратор старинных манускриптов / Архивариус / Лаборант-исследователь.",
            innovator: "Автор бестселлеров / Музыкант / Художник-фрилансер.",
            communicator: "Владелец небольшого уютного кафе / Организатор путешествий / Психолог-консультант.",
            pragmatist: "Дизайнер экоследующих продуктов / Инженер-изобретатель / Архитектор."
          }
        },
        {
          question: "9. Ваша самая частая 'внутренняя критика' на нынешней или предыдущей работе звучит так:",
          options: {
            analyst: "'Ты слишком медлительный/перфекционист, везде хочешь докопаться до сути'.",
            innovator: "'Тебе не хватает системности, ты слишком импульсивен и не доводишь начатое до конца'.",
            communicator: "'Ты слишком много берешь на себя, не умеешь говорить 'нет' и делегировать'.",
            pragmatist: "'Ты недостаточно рискуешь, слишком осторожничаешь и боишься выделиться'."
          }
        },
        {
          question: "10. Что для вас важнее в коллеге или партнере?",
          options: {
            analyst: "Экспертность и глубина. Глубокие знания в своей узкой области.",
            innovator: "Гибкость и открытость. Способность слышать другую точку зрения и адаптироваться.",
            communicator: "Надежность и ответственность. Я должен быть уверен, что на него можно положиться.",
            pragmatist: "Энтузиазм и амбициозность. Стремление к большему и способность заряжать энергией."
          }
        },
                {
          question: "11. Когда вы принимаете сложное решение, вы в большей степени опираетесь на:",
          options: {
            analyst: "Логику, анализ данных, прогнозы и проверенную информацию.",
            innovator: "Интуицию, 'внутреннее чутье' и видение общей картины.",
            communicator: "Чувства и эмоции – как свои, так и окружающих людей.",
            pragmatist: "Практический опыт – свой и чужой, 'а как было раньше'."
          }
        },
        {
          question: "12. Как вы относитесь к публичным выступлениям и необходимости отстаивать свою точку зрения перед группой людей?",
          options: {
            analyst: "Это стресс, но необходимый. Я к нему готовлюсь, и мне важно, чтобы мои аргументы были железобетонными.",
            innovator: "Это моя стихия. Я люблю быть в центре внимания и вести за собой аудиторию.",
            communicator: "Это приемлемо, если тема мне действительно близка и я в ней разбираюсь.",
            pragmatist: "Я предпочитаю донести свою точку зрения в письменном виде или в личной беседе."
          }
        },
        {
          question: "13. Ваше отношение к конфликтам на работе:",
          options: {
            analyst: "Воспринимаю их как неизбежное зло, которое нужно максимально быстро и безболезненно погасить.",
            innovator: "Вижу в них источник роста и возможность вскрыть реальные проблемы.",
            communicator: "Стараюсь избегать любой ценой, так как они разрушают гармонию в коллективе.",
            pragmatist: "Не боюсь их, если это конфликт идей, а не личностей. Могу быть жестким в споре."
          }
        },
        {
          question: "14. Что для вас важнее в работе?",
          options: {
            analyst: "Стабильность и предсказуемость: четкий график, гарантированная зарплата, понятные перспективы.",
            innovator: "Свобода и автономность: возможность самому управлять своим временем и задачами.",
            communicator: "Вызов и рост: постоянное развитие, освоение нового, движение вверх по карьерной лестнице.",
            pragmatist: "Смысл и impact: ощущение, что моя работа делает мир или чью-то жизнь лучше."
          }
        },
        {
          question: "15. Когда вы учитесь чему-то новому, вам проще всего:",
          options: {
            analyst: "Работать с текстовыми инструкциями, схемами и технической документацией.",
            innovator: "Смотреть видеоуроки или наблюдать за действиями эксперта.",
            communicator: "Пробовать сразу на практике, методом проб и ошибок.",
            pragmatist: "Дискутировать с другими, задавать вопросы и обсуждать материал."
          }
        },
        {
          question: "16. Какая рабочая среда вас демотивирует больше всего?",
          options: {
            analyst: "Открытое space, где все на виду, постоянный шум и отвлекающие факторы.",
            innovator: "Жесткая иерархическая структура, где нельзя обратиться к начальству через голову непосредственного руководителя.",
            communicator: "Аморфная среда, где нет лидеров, четких целей и непонятно, кто за что отвечает.",
            pragmatist: "Консервативная среда, где не приветствуются новые идеи и царит принцип 'так было всегда'."
          }
        },
        {
          question: "17. Ваша мотивация сильно падает, когда:",
          options: {
            analyst: "Я не понимаю, как моя конкретная задача связана с общими целями компании.",
            innovator: "Мои усилия и достижения остаются незамеченными руководством и коллегами.",
            communicator: "Я чувствую, что перестал учиться и расти профессионально, топчусь на месте.",
            pragmatist: "Меня постоянно торопят и не дают возможности сделать работу качественно и вдумчиво."
          }
        },
        {
          question: "18. Если бы вам пришлось выбирать, какая из этих задач покажется вам наименее сложной?",
          options: {
            analyst: "Убедить инвестора вложить деньги в рискованный, но перспективный проект.",
            innovator: "Написать подробное техническое руководство на 50 страниц для сложного программного обеспечения.",
            communicator: "Организовать корпоративное мероприятие на 200 человек, учесть все пожелания и диеты.",
            pragmatist: "В одиночку разработать концепцию и дизайн нового мобильного приложения."
          }
        },
        {
          question: "19. Что для вас является главным показателем ценности выполненной работы?",
          options: {
            analyst: "Внутреннее ощущение 'сделано на совесть', соответствие моим высоким стандартам.",
            innovator: "Признание и благодарность от клиентов, коллег или общества.",
            communicator: "Конкретные измеримые результаты: прибыль, охват, количество внедренных решений.",
            pragmatist: "Личный профессиональный рост и приобретение новых уникальных компетенций."
          }
        },
        {
          question: "20. Как вы относитесь к многозадачности?",
          options: {
            analyst: "Плохо. Я предпочитаю полностью погрузиться в одну задачу, закончить ее и только потом браться за следующую.",
            innovator: "Это неизбежность современного мира. Я научился с этим жить, хотя это не всегда эффективно.",
            communicator: "Это мое естественное состояние. Мне нравится переключаться между разными проектами.",
            pragmatist: "Я сознательно избегаю ее, так как она приводит к поверхностности и ошибкам."
          }
        },
        {
          question: "21. Ваша самая сильная сторона в командной работе – это способность:",
          options: {
            analyst: "Видеть слабые места в плане и предупреждать о возможных рисках.",
            innovator: "Генерировать множество идей и заряжать команду энтузиазмом.",
            communicator: "Объединять людей, сглаживать углы и поддерживать здоровую атмосферу.",
            pragmatist: "Взять на себя самую сложную и ответственную часть проекта."
          }
        },
        {
          question: "22. Что для вас важнее на данном этапе карьеры?",
          options: {
            analyst: "Получить максимум знаний и навыков, стать высококлассным специалистом.",
            innovator: "Построить прочную сеть профессиональных контактов (networking).",
            communicator: "Заработать репутацию и авторитет в своей области.",
            pragmatist: "Найти баланс между работой и личной жизнью."
          }
        },
        {
          question: "23. Когда вы сталкиваетесь с неудачей, ваша первая внутренняя реакция:",
          options: {
            analyst: "'Что я сделал не так? Где была ошибка в моих расчетах/действиях?'.",
            innovator: "'Как я могу это обыграть? Какие есть скрытые возможности в этой ситуации?'.",
            communicator: "'Кто виноват? Почему меня не поддержали?' / 'Что теперь подумают другие?'.",
            pragmatist: "'Нужно просто работать усерднее. В следующий раз я обязательно справлюсь'."
          }
        },
        {
          question: "24. Какой комплимент от руководителя был бы для вас самым ценным?",
          options: {
            analyst: "'Ваш анализ спас нас от серьезных финансовых потерь'.",
            innovator: "'Ваша идея задала совершенно новое направление для всего нашего проекта'.",
            communicator: "'Благодаря вашему умению договариваться, конфликт был исчерпан в зародыше'.",
            pragmatist: "'На вас всегда можно положиться, вы – наш самый надежный сотрудник'."
          }
        },
        {
          question: "25. Что вызывает у вас большее сопротивление?",
          options: {
            analyst: "Необходимость слепо следовать указаниям, не понимая их конечной цели.",
            innovator: "Микроменеджмент, когда руководитель контролирует каждый ваш шаг.",
            communicator: "Необходимость работать с устаревшими, неэффективными инструментами или процессами.",
            pragmatist: "Давление и манипуляции со стороны коллег или начальства."
          }
        },
        {
          question: "26. Представьте, что вы пишете книгу о своей профессиональной жизни. Какой бы был заголовок?",
          options: {
            analyst: "'Как порядок победил хаос: история системного мыслителя'.",
            innovator: "'От идеи к реальности: путь созидателя'.",
            communicator: "'Люди – главный актив: искусство соединения душ'.",
            pragmatist: "'В погоне за вызовом: почему мне всегда было мало'."
          }
        },
        {
          question: "27. Ваше отношение к деньгам как к мотиватору:",
          options: {
            analyst: "Деньги – это важный измеритель моей профессиональной ценности на рынке.",
            innovator: "Деньги – это в первую очередь свобода и возможность не думать о быте.",
            communicator: "Деньги – это ресурс для реализации более масштабных идей и проектов.",
            pragmatist: "Деньги – это следствие, а не причина. Если я делаю дело хорошо, деньги придут."
          }
        },
        {
          question: "28. Что для вас означает 'быть профессионалом'?",
          options: {
            analyst: "Нести ответственность за свои слова и действия, выполнять обещания.",
            innovator: "Постоянно быть в курсе последних трендов и технологий в своей области.",
            communicator: "Уметь находить общий язык с любым человеком и решать самые сложные межличностные проблемы.",
            pragmatist: "Создавать продукты или решения, которые опережают свое время."
          }
        },
        {
          question: "29. Как вы относитесь к роли наставника для менее опытных коллег?",
          options: {
            analyst: "Это моя ответственность и долг – передавать знания дальше.",
            innovator: "Это приятно, когда видишь искру в глазах ученика и его рост.",
            communicator: "Это отнимает слишком много времени и энергии, которые я мог бы потратить на свою работу.",
            pragmatist: "Я бы с удовольствием делился опытом, если бы меня попросили."
          }
        },
        {
          question: "30. Закончите фразу: 'Идеальная работа – это та, где я...'",
          options: {
            analyst: "'...могу полностью сосредоточиться на решении сложных интеллектуальных задач.'",
            innovator: "'...вижу прямой результат своего труда и его положительное влияние на мир.'",
            communicator: "'...окружен интересными, вдохновляющими людьми, с которыми мы делаем общее дело.'",
            pragmatist: "'...имею возможность постоянно бросать вызов самому себе и выходить из зоны комфорта.'"
          }
        }
      ];

      // РАСШИРЕННЫЕ РЕЗУЛЬТАТЫ ТЕСТА С БОЛЬШИМ ВЫБОРОМ ПРОФЕССИЙ
      const testResults = {
        analyst: {
          title: "Аналитик-стратег",
          description: "Вы сохраняете хладнокровие в сложных ситуациях, любите порядок и тщательно проверенные решения. Ваша сила - в способности видеть системные взаимосвязи и находить оптимальные пути решения.",
          values: "Четкие цели, прозрачные правила игры и глубокая экспертиза.",
          professions: [
            "Data Scientist", "Финансовый аналитик", "Системный архитектор", "Инженер-исследователь", 
            "Продуктовый аналитик", "Бизнес-аналитик", "Маркетинговый аналитик", "Кредитный аналитик",
            "Инвестиционный аналитик", "Системный администратор", "Сетевой инженер", "Архитектор баз данных",
            "Биоинформатик", "Статистик", "Актуарий", "Аналитик кибербезопасности"
          ],
          actions: [
            "Развивайте навыки работы с данными и аналитическими инструментами (SQL, Python, BI-платформы).",
            "Собирайте портфолио кейсов, демонстрирующих вашу способность принимать взвешенные решения.",
            "Выбирайте команды, где ценят аргументы и структурное мышление."
          ],
          recommendedUniversities: ["kaznu", "satbayev", "kbtu"]
        },
        innovator: {
          title: "Инноватор-visioner",
          description: "Вы мыслите смело, легко генерируете идеи и ищете новые способы создавать ценность. Ваше преимущество - в способности видеть возможности там, где другие видят ограничения.",
          values: "Свобода экспериментов, творческая атмосфера и ощущение влияния на будущее.",
          professions: [
            "Продуктовый менеджер", "UX/UI-дизайнер", "Креативный директор", "Стартап-предприниматель", 
            "Стратег по инновациям", "Арт-директор", "Гейм-дизайнер", "Дизайнер интерфейсов",
            "Маркетолог-стратег", "Бренд-менеджер", "Копирайтер", "SMM-специалист",
            "Event-менеджер", "PR-менеджер", "Дизайнер одежды", "Архитектор"
          ],
          actions: [
            "Работайте над разнообразными проектами, чтобы пополнять банк идей и кейсов.",
            "Изучайте методы дизайн-мышления, agile-подходы и Customer Development.",
            "Ищите партнеров, готовых поддержать смелые эксперименты и пилоты."
          ],
          recommendedUniversities: ["atu", "abylai", "dku"]
        },
        communicator: {
          title: "Коммуникатор-интегратор",
          description: "Вы тонко чувствуете людей, создаете доверие и умеете превращать разрозненные интересы в общий результат. Ваш дар - в способности находить общий язык с самыми разными людьми.",
          values: "Сильная команда, прозрачная коммуникация и ощущение значимости своей роли.",
          professions: [
            "HR-бизнес-партнер", "Руководитель проектов", "Бизнес-тренер", "PR-специалист", 
            "Консультант по изменениям", "Менеджер по продажам", "Рекрутер", "Коуч",
            "Психолог", "Социальный работник", "Учитель", "Воспитатель",
            "Менеджер по работе с клиентами", "Торговый представитель", "Менеджер по туризму", "Журналист"
          ],
          actions: [
            "Развивайте навыки фасилитации, конфликт-менеджмента и эмоционального интеллекта.",
            "Формируйте личный бренд эксперта по работе с людьми и сложными переговорами.",
            "Выбирайте проекты, где требуется объединять разные команды и стейкхолдеров."
          ],
          recommendedUniversities: ["abai", "abylai", "dku"]
        },
        pragmatist: {
          title: "Прагматик-созидатель",
          description: "Вы ориентированы на ощутимый результат, любите доводить идеи до конкретных решений и продуктов. Ваша сила - в практичности и способности превращать концепции в работающие системы.",
          values: "Практическая польза, автономность и ощущение личного прогресса.",
          professions: [
            "Инженер по продукту", "Технический лидер", "Архитектор", "Операционный директор", 
            "Инженер-дизайнер", "Программист", "Тестировщик", "DevOps-инженер",
            "Системный инженер", "Инженер-строитель", "Инженер-механик", "Инженер-электрик",
            "Технолог", "Логист", "Снабженец", "Производственный менеджер"
          ],
          actions: [
            "Работайте над проектами, где можно увидеть эффект своими глазами (продукты, сервисы, инфраструктура).",
            "Комбинируйте стратегическое планирование с регулярными ретроспективами для личного роста.",
            "Накапливайте доказательства своей надежности: реализованные проекты, отзывы, метрики."
          ],
          recommendedUniversities: ["satbayev", "kbtu", "atu"]
        }
      };

      let currentUniversityContext = null;
      let currentTestMessageElement = null;
      let currentTestState = {
        inProgress: false,
        currentQuestion: 0,
        answers: [],
        userInterests: []
      };

      let currentTestResult = null;

      function findUniversityByName(message) {
        const lower = message.toLowerCase();
        for (const [key, uni] of Object.entries(universities)) {
          if (uni.aliases.some(alias => lower.includes(alias))) {
            return key;
          }
        }
        return null;
      }

      function getUniversityInfo(universityKey, infoType = 'all') {
        const uni = universities[universityKey];
        if (!uni) return null;

        switch (infoType) {
          case 'military':
            return `🎖️ ${uni.name}\n\nВоенная кафедра: ${uni.military}`;
          case 'scores':
            return `📊 ${uni.name}\n\nПороговые баллы ЕНТ: ${uni.scores}`;
          case 'budget':
            return `💰 ${uni.name}\n\nБюджетные места: ${uni.budget}`;
          case 'directions':
            return `🎯 ${uni.name}\n\nОсновные направления: ${uni.directions}`;
          case 'all':
            return `🏫 ${uni.name}\n\n🎖️ Военная кафедра: ${uni.military}\n📊 Баллы ЕНТ: ${uni.scores}\n💰 Бюджет: ${uni.budget}\n🎯 Направления: ${uni.directions}`;
          default:
            return `🏫 ${uni.name}\n\n${uni.directions}`;
        }
      }

      function showUniversityButtons(messageType) {
        const buttonsMessage = document.createElement('div');
        buttonsMessage.className = 'message bot-message animate-fade-in';
        
        let html = `<div class="test-question">
          <strong>Выберите университет для получения информации:</strong><br><br>
          <div style="display: flex; flex-wrap: wrap; gap: 5px;">`;
        
        Object.entries(universities).forEach(([key, uni]) => {
          const shortName = uni.name.split('(')[0].trim();
          html += `<button class="university-button" onclick="handleUniversitySelect('${key}', '${messageType}')">${shortName}</button>`;
        });
        
        html += `</div></div>`;
        buttonsMessage.innerHTML = html;
        chatContainer.appendChild(buttonsMessage);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function handleUniversitySelect(universityKey, infoType) {
        const info = getUniversityInfo(universityKey, infoType);
        if (info) {
          const infoMessage = document.createElement('div');
          infoMessage.className = 'message bot-message animate-fade-in';
          infoMessage.textContent = info;
          chatContainer.appendChild(infoMessage);
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }
      }

      function showUniversityRecommendations(testResultType) {
        const profile = testResults[testResultType];
        if (!profile || !profile.recommendedUniversities) return;

        const recommendationsMessage = document.createElement('div');
        recommendationsMessage.className = 'message bot-message animate-fade-in';
        
        let html = `<div class="test-question">
          <strong>🎓 Рекомендованные университеты для вас:</strong><br><br>`;
        
        profile.recommendedUniversities.forEach(uniKey => {
          const uni = universities[uniKey];
          if (uni) {
            html += `
              <div class="university-card">
                <strong>${uni.name}</strong><br>
                ${uni.description}<br>
                <strong>Сильные стороны:</strong> ${uni.strengths.join(", ")}<br><br>
                <a href="${uni.url}" target="_blank" class="university-link">Подробнее об университете →</a>
              </div>
            `;
          }
        });
        
        html += `<br>
          <button class="recommendation-button" onclick="showAllUniversityOptions()">
            Показать все варианты университетов
          </button>
        </div>`;
        
        recommendationsMessage.innerHTML = html;
        chatContainer.appendChild(recommendationsMessage);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function showAllUniversityOptions() {
        const allUniversitiesMessage = document.createElement('div');
        allUniversitiesMessage.className = 'message bot-message animate-fade-in';
        
        let html = `<div class="test-question">
          <strong>🏛️ Все университеты в нашем каталоге:</strong><br><br>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">`;
        
        Object.entries(universities).forEach(([key, uni]) => {
          html += `
            <div class="university-card">
              <strong>${uni.name.split('(')[0].trim()}</strong><br>
              <em>${uni.description}</em><br><br>
              <a href="${uni.url}" target="_blank" class="university-link">Подробнее →</a>
            </div>
          `;
        });
        
        html += `</div><br>
          <p><strong>Если какая-то специальность или вуз вас заинтересовали, напишите мне - расскажу подробнее!</strong></p>
        </div>`;
        
        allUniversitiesMessage.innerHTML = html;
        chatContainer.appendChild(allUniversitiesMessage);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function showProfessionDetails(profession) {
        const professionMessage = document.createElement('div');
        professionMessage.className = 'message bot-message animate-fade-in';
        
        // Здесь можно добавить более детальную информацию о профессии
        let html = `<div class="test-question">
          <strong>💼 ${profession}</strong><br><br>`;
        
        // Добавляем общее описание для разных категорий профессий
        if (profession.includes('аналитик') || profession.includes('Analyst')) {
          html += `
            <p>Эта профессия требует аналитического мышления, работы с данными и умения находить закономерности. Аналитики востребованы в IT, финансах, маркетинге и многих других отраслях.</p>
            <p><strong>Ключевые навыки:</strong> работа с данными, статистика, аналитическое мышление, визуализация данных</p>
          `;
        } else if (profession.includes('дизайн') || profession.includes('Design')) {
          html += `
            <p>Творческая профессия, сочетающая художественные навыки с техническими знаниями. Дизайнеры создают визуальные решения для продуктов, интерфейсов, брендов и пространств.</p>
            <p><strong>Ключевые навыки:</strong> креативность, работа с графическими редакторами, понимание UX/UI, коммуникация</p>
          `;
        } else if (profession.includes('менеджер') || profession.includes('Manager')) {
          html += `
            <p>Профессия, ориентированная на управление процессами, людьми или проектами. Менеджеры обеспечивают эффективную работу команд и достижение бизнес-целей.</p>
            <p><strong>Ключевые навыки:</strong> лидерство, коммуникация, планирование, решение проблем</p>
          `;
        } else if (profession.includes('инженер') || profession.includes('Engineer')) {
          html += `
            <p>Техническая профессия, связанная с проектированием, разработкой и оптимизацией систем и процессов. Инженеры работают в различных отраслях промышленности и IT.</p>
            <p><strong>Ключевые навыки:</strong> техническое мышление, математика, проектирование, решение технических задач</p>
          `;
        } else {
          html += `
            <p>Эта профессия требует специальных знаний и навыков, которые можно получить через соответствующее образование и практический опыт.</p>
            <p>Хотите узнать о конкретных вузах, где готовят специалистов этого направления?</p>
          `;
        }
        
        html += `<br>
          <button class="university-button" onclick="showAllUniversityOptions()">
            Посмотреть подходящие вузы
          </button>
        </div>`;
        
        professionMessage.innerHTML = html;
        chatContainer.appendChild(professionMessage);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function findAnswer(message) {
        const words = message
          .toLowerCase()
          .split(/[^a-zа-яё0-9ё]+/i)
          .filter(w => w && !stopWords.includes(w));
        let best = { answer: defaultReply, score: 0 };
        
        faq.forEach(item => {
          const score = item.keywords.reduce(
            (sum, kw) => words.includes(kw) ? sum + 1 : sum,
            0
          );
          if (score > best.score) best = { answer: item.answer, score };
        });

        // Проверка на запрос теста
        if (best.answer === 'test' || words.some(w => ['тест', 'профориентация', 'опрос'].includes(w))) {
          startProforientationTest();
          return '';
        }

        // Проверка на вопросы об университетах
        if (best.answer === 'military' || best.answer === 'scores' || best.answer === 'budget' || best.answer === 'directions') {
          const foundUni = findUniversityByName(message);
          if (foundUni) {
            return getUniversityInfo(foundUni, best.answer);
          } else {
            showUniversityButtons(best.answer);
            return '';
          }
        }

        // Общий вопрос об университетах
        if (best.answer === 'university') {
          const foundUni = findUniversityByName(message);
          if (foundUni) {
            return getUniversityInfo(foundUni, 'all');
          } else {
            showUniversityButtons('all');
            return '';
          }
        }

        return best.answer;
      }

      function startProforientationTest() {
        currentTestState = {
          inProgress: true,
          currentQuestion: 0,
          answers: [],
          userInterests: []
        };
        currentTestMessageElement = null;        
        showTestQuestion(0);
      }

      function showTestQuestion(questionIndex) {
        const question = proforientationTest[questionIndex];
        
        let html = `<div class="test-question">
          <strong>Вопрос ${questionIndex + 1}/${proforientationTest.length}</strong><br>
          ${question.question}
          <div style="margin-top: 10px;">`;

        Object.entries(question.options).forEach(([type, optionText]) => {
          html += `<button class="test-option" onclick="handleTestAnswer(${questionIndex}, '${type}')">${optionText}</button>`;
        });
        
        html += `</div></div>`;
        if (currentTestMessageElement) {
          currentTestMessageElement.innerHTML = html;
        } else {
          const testMessage = document.createElement('div');
          testMessage.className = 'message bot-message animate-fade-in';
          testMessage.innerHTML = html;
          chatContainer.appendChild(testMessage);
          currentTestMessageElement = testMessage;
        }

        requestAnimationFrame(() => {
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        });
      }

      function handleTestAnswer(questionIndex, answerType) {
        currentTestState.answers[questionIndex] = answerType;
        currentTestState.currentQuestion++;
        
        if (currentTestState.currentQuestion < proforientationTest.length) {
          showTestQuestion(currentTestState.currentQuestion);
        } else {
          finishTest();
        }
      }

      function finishTest() {
        const resultType = calculateTestResult();
        currentTestResult = resultType;
        const profile = testResults[resultType];
        if (!profile) {
          currentTestState.inProgress = false;
          return;
        }

        // Создаем список профессий с кнопками для подробностей
        const professionsList = profile.professions.map(prof => 
          `<button class="profession-button" onclick="showProfessionDetails('${prof}')">${prof}</button>`
        ).join('');

        const actionsList = profile.actions && profile.actions.length
          ? `<ul style="margin: 0.5rem 0 0 1.25rem; list-style: disc;">
              ${profile.actions.map(action => `<li>${action}</li>`).join('')}
            </ul>`
          : '';
        
        let html = `<div class="test-question">
          <strong>🎉 Результаты вашего теста!</strong><br><br>
          <strong>Ваш ведущий архетип: ${profile.title}</strong><br>
          ${profile.description}<br><br>
          <strong>Что вас заряжает:</strong><br>
          ${profile.values}<br><br>
          <strong>Подходящие профессии (${profile.professions.length} вариантов):</strong><br>
          <div style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0;">
            ${professionsList}
          </div>
          <br>
          <strong>Рекомендации к развитию:</strong>
          ${actionsList}
          <br>
          <button class="recommendation-button" onclick="showUniversityRecommendations('${resultType}')">
            🎓 Показать рекомендованные вузы
          </button>
        </div>`;
        
        if (currentTestMessageElement) {
          currentTestMessageElement.innerHTML = html;
        } else {
          const resultMessage = document.createElement('div');
          resultMessage.className = 'message bot-message animate-fade-in';
          resultMessage.innerHTML = html;
          chatContainer.appendChild(resultMessage);
        }

        currentTestMessageElement = null;
        currentTestState.inProgress = false;
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function calculateTestResult() {
        const scores = {
          analyst: 0,
          innovator: 0,
          communicator: 0,
          pragmatist: 0
        };

        currentTestState.answers.forEach(answerType => {
          if (answerType && Object.prototype.hasOwnProperty.call(scores, answerType)) {
            scores[answerType]++;
          }
        });
        
        const bestEntry = Object.entries(scores).reduce(
          (best, entry) => (entry[1] > best[1] ? entry : best),
          [null, -Infinity]
        );

        return bestEntry[0] || 'analyst';
      }

      // Делаем функции глобальными для обработки кликов
      window.handleTestAnswer = handleTestAnswer;
      window.handleUniversitySelect = handleUniversitySelect;
      window.showUniversityRecommendations = showUniversityRecommendations;
      window.showAllUniversityOptions = showAllUniversityOptions;
      window.showProfessionDetails = showProfessionDetails;

      let pendingMedia = [];

      function clearMediaPreview() {
        pendingMedia = [];
        mediaPreview.innerHTML = '';
        mediaPreview.classList.add('hidden');
        cancelMediaButton.classList.add('hidden');
      }

      function updateMediaPreview() {
        mediaPreview.innerHTML = '';
        pendingMedia.forEach((media, index) => {
          const div = document.createElement('div');
          div.className = 'media-preview-item';
          div.innerHTML = `
            <img src="${media}" alt="Preview">
            <button data-index="${index}" type="button"><i class="fas fa-times"></i></button>
          `;
          mediaPreview.appendChild(div);
          div.querySelector('button').addEventListener('click', () => {
            pendingMedia.splice(index, 1);
            updateMediaPreview();
          });
        });
        mediaPreview.classList.toggle('hidden', pendingMedia.length === 0);
        cancelMediaButton.classList.toggle('hidden', pendingMedia.length === 0);
      }

      function handleFileInput(e) {
        const files = e.target.files;
        if (files.length) {
          Array.from(files).forEach(file => {
            if (!file.type.startsWith('image/')) {
              alert('Пожалуйста, выберите изображение');
              return;
            }
            const reader = new FileReader();
            reader.onload = (event) => {
              pendingMedia.push(event.target.result);
              updateMediaPreview();
            };
            reader.readAsDataURL(file);
          });
          e.target.value = '';
        }
      }

      function createNewChat() {
        // Очищаем контейнер чата
        chatContainer.innerHTML = '';
        
        // Сбрасываем состояние теста
        currentTestState = {
          inProgress: false,
          currentQuestion: 0,
          answers: [],
          userInterests: []
        };
        currentTestMessageElement = null;        
        currentTestResult = null;
        
        // Сбрасываем контекст университета
        currentUniversityContext = null;
        
        // Показываем приветственное сообщение
        const welcomeMsg = document.createElement('div');
        welcomeMsg.className = 'message bot-message animate-fade-in';
        welcomeMsg.textContent = 'Привет! Я ИИ-консультант NeXus. Помогу с выбором профессии, подбором вуза и профориентацией. Можете пройти быстрый тест или задать вопрос о конкретных университетах Казахстана!';
        chatContainer.appendChild(welcomeMsg);
        
        // Очищаем поле ввода
        chatInput.value = '';
        
        // Очищаем превью медиа
        clearMediaPreview();
        
        // Прокручиваем вниз
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function handleChatSubmit(e) {
        e.preventDefault();
        e.stopPropagation();

        const message = chatInput.value.trim();
        const hasMedia = pendingMedia.length > 0;

        if (!message && !hasMedia) return;

        // Если идет тест, обрабатываем ответы через кнопки
        if (currentTestState.inProgress) {
          const userMsg = document.createElement('div');
          userMsg.className = 'message user-message animate-fade-in';
          userMsg.textContent = message;
          chatContainer.appendChild(userMsg);
          
          const botMsg = document.createElement('div');
          botMsg.className = 'message bot-message animate-fade-in';
          botMsg.textContent = 'Пожалуйста, выбирайте ответы с помощью кнопок выше для точности тестирования.';
          chatContainer.appendChild(botMsg);
          
          chatInput.value = '';
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
          return;
        }

        // Add user message
        if (message) {
          const userMsg = document.createElement('div');
          userMsg.className = 'message user-message animate-fade-in';
          userMsg.textContent = message;
          chatContainer.appendChild(userMsg);
        }

        // Add media if any
        if (hasMedia) {
          pendingMedia.forEach(media => {
            const mediaMsg = document.createElement('div');
            mediaMsg.className = 'message message-image user-message animate-fade-in';
            mediaMsg.innerHTML = `<img src="${media}" alt="Sent image">`;
            chatContainer.appendChild(mediaMsg);
          });
        }

        // Force DOM update and scroll to bottom
        requestAnimationFrame(() => {
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        });

        // Clear input and media
        chatInput.value = '';
        clearMediaPreview();

        // Add bot response after delay
        setTimeout(() => {
          const answer = findAnswer(message);
          if (answer) {
            const botMsg = document.createElement('div');
            botMsg.className = 'message bot-message animate-fade-in';
            botMsg.textContent = answer;
            chatContainer.appendChild(botMsg);
            
            requestAnimationFrame(() => {
              chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
            });
          }
        }, 500);
      }

      // Event listeners
      chatFileInput.addEventListener('change', handleFileInput);
      cancelMediaButton.addEventListener('click', clearMediaPreview);
      chatForm.addEventListener('submit', handleChatSubmit);
      clearChatButton.addEventListener('click', createNewChat);

      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleChatSubmit(e);
        }
      });

      // Создаем новый чат при каждой загрузке страницы
      createNewChat();
    });
  </script>
{% endblock %}